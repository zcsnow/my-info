function playAgain(a){document.oncllick=null;_stage.onmousemove=null;$("#submitBtn").unbind("mousedown");$("#playBtn").unbind("mousedown");$("#scoreForm").css("display","none");if(_level!=undefined){if(_menuFromGame){_menuFromGame=false;switchGameState(GameStates.GAME_STATE_TITLE)}else{switchGameState(GameStates.GAME_STATE_NEW_LEVEL)}}else{_stage.clearRect(0,0,_canvas.width,_canvas.height);switchGameState(GameStates.GAME_STATE_TITLE)}}function getRecords(){_recordScreen.drawScore(_totalScore);$.post("scoreoid_proxy.php",{action:"curl_request",method:"getScores",response:"JSON",order_by:"score",order:"desc",limit:20},function(data){_currentScreen="records";document.onclick=playAgain;_canvas.onmousemove=checkRollOvers;var arr=eval(data);_recordScreen.setRecordData(arr)})}function submitScore(a){var b=$("#scoreTxt").val();if(b==""){return}$("#submitBtn").unbind("mousedown");$("#submitBtn").css("opacity",.5);$.post("scoreoid_proxy.php",{action:"curl_request",method:"createScore",response:"JSON",score:_totalScore,username:b,difficulty:_level-1},function(a){$("#scoreForm").css("display","none");getRecords()})}function focusField(){$("#scoreTxt").focus()}function initScoreForm(){$("#submitBtn").css("opacity",1);$("#scoreForm").css("display","block");$("#submitBtn").mousedown(submitScore);$("#playBtn").mousedown(playAgain);setTimeout(focusField,500)}function trace(a){console.log(a)}function checkGameWin(){var a;var b;var c=true;for(a=0;a<_tiles.length;a++){b=_tiles[a];if(b.getValue()=="black"){c=false}}if(!c){document.onclick=boardClicked;switchGameState(GameStates.GAME_STATE_WAIT_FOR_FLIP)}else{if(_userCurrentLevel==_level){window.localStorage.setItem("level",_level+1);_userCurrentLevel=_level+1}_currentScreen="";_canvas.onmousemove=null;document.onclick=checkLevelWinClick;_level++;switchGameState(GameStates.GAME_STATE_FADE_LEVEL)}}function flipTiles(){_bonus-=BONUS_INC;var a=_currentTile.getKey();var b;var c;var d=_levelData["level"+_level];var e=d.size;b=_tiles[a-1];if(b!=undefined){c=b.getKey()+1;if(c%e!=0){b.flip()}}b=_tiles[a+1];if(b!=undefined){c=b.getKey();if(c%e!=0){b.flip()}}b=_tiles[a-e];if(b!=undefined){b.flip()}b=_tiles[a+e];if(b!=undefined){b.flip()}_currentTile.flip();switchGameState(GameStates.GAME_STATE_FLIP_TILES)}function checkLevelWinClick(a){if(a.layerX||a.layerX==0){_mouse.x=a.layerX;_mouse.y=a.layerY}else if(a.offsetX||a.offsetX==0){_mouse.x=a.offsetX-_canvas.offsetLeft;_mouse.y=a.offsetY-_canvas.offsetTop}var b;b=_levelWinScreen.getContinueRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){}else{document.onclick=null;_canvas.onmousemove=null;switchGameState(GameStates.GAME_STATE_NEW_LEVEL);return}b=_levelWinScreen.getSubmitRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){}else{document.onclick=null;_canvas.onmousemove=null;_stage.clearRect(0,0,_canvas.width,_canvas.height);switchGameState(GameStates.GAME_STATE_WAITING_FOR_NEW_GAME);initScoreForm();return}}function boardClicked(a){_currentTile=null;if(a.layerX||a.layerX==0){_mouse.x=a.layerX;_mouse.y=a.layerY}else if(a.offsetX||a.offsetX==0){_mouse.x=a.offsetX-_canvas.offsetLeft;_mouse.y=a.offsetY-_canvas.offsetTop}var b;b=_menuBtn.rect;if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){}else{document.onclick=null;_menuFromGame=true;switchGameState(GameStates.GAME_STATE_TITLE);return}b=_restartBtn.rect;if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){}else{document.onclick=null;_canvas.onmousemove=null;_currentScreen="";switchGameState(GameStates.GAME_STATE_NEW_LEVEL);return}var c;var d;for(c=0;c<_tiles.length;c++){d=_tiles[c];b=d.getRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){continue}else{document.onclick=null;_currentTile=d;break}}if(_currentTile!=null){flipTiles()}else{document.onclick=boardClicked}}function checkLevelClicked(a){if(a.layerX||a.layerX==0){_mouse.x=a.layerX;_mouse.y=a.layerY}else if(a.offsetX||a.offsetX==0){_mouse.x=a.offsetX-_canvas.offsetLeft;_mouse.y=a.offsetY-_canvas.offsetTop}var b=_levelScreen.checkLevelClicked();if(b==0){return}else{document.onclick=null;_level=b;_totalScore=0;if(_level==1){switchGameState(GameStates.GAME_STATE_HELP)}else{switchGameState(GameStates.GAME_STATE_NEW_GAME)}return}}function checkHelpClicked(a){if(a.layerX||a.layerX==0){_mouse.x=a.layerX;_mouse.y=a.layerY}else if(a.offsetX||a.offsetX==0){_mouse.x=a.offsetX-_canvas.offsetLeft;_mouse.y=a.offsetY-_canvas.offsetTop}var b=_helpScreen.getPlayBtnRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){}else{document.onclick=null;if(_helpScreenOn){_helpScreenOn=false;switchGameState(GameStates.GAME_STATE_NEW_GAME)}else{switchGameState(GameStates.GAME_STATE_LEVEL_SCREEN)}return}}function checkPlayClicked(a){if(a.layerX||a.layerX==0){_mouse.x=a.layerX;_mouse.y=a.layerY}else if(a.offsetX||a.offsetX==0){_mouse.x=a.offsetX-_canvas.offsetLeft;_mouse.y=a.offsetY-_canvas.offsetTop}var b=_titleScreen.getPlayBtnRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){}else{_canvas.onmousemove=null;document.onclick=null;if(_helpScreenOn){_helpScreenOn=false;switchGameState(GameStates.GAME_STATE_NEW_GAME)}else{switchGameState(GameStates.GAME_STATE_LEVEL_SCREEN)}return}b=_titleScreen.getScoresBtnRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){}else{document.onclick=null;_canvas.onmousemove=null;if(_helpScreenOn){_helpScreenOn=false;switchGameState(GameStates.GAME_STATE_NEW_GAME)}else{getRecords()}}}function checkRollOvers(a){trace(_currentScreen);if(_currentScreen==""){return}if(a.layerX||a.layerX==0){_mouse.x=a.layerX;_mouse.y=a.layerY}else if(a.offsetX||a.offsetX==0){_mouse.x=a.offsetX-_canvas.offsetLeft;_mouse.y=a.offsetY-_canvas.offsetTop}var b;switch(_currentScreen){case"title":b=_titleScreen.getPlayBtnRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){_titleScreen.renderPlayOut()}else{_titleScreen.renderPlayRoll();return}b=_titleScreen.getScoresBtnRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){_titleScreen.renderScoresOut()}else{_titleScreen.renderScoresRoll();return}break;case"help":b=_helpScreen.getPlayBtnRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){_helpScreen.renderPlayOut()}else{_helpScreen.renderPlayRoll();return}break;case"levelWin":b=_levelWinScreen.getContinueRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){_levelWinScreen.renderPlayOut()}else{_levelWinScreen.renderPlayRoll();return}b=_levelWinScreen.getSubmitRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){_levelWinScreen.renderScoresOut()}else{_levelWinScreen.renderScoresRoll();return}break;case"records":b=_recordScreen.getContinueRect();if(_mouse.x<b.left||_mouse.x>b.right||_mouse.y<b.top||_mouse.y>b.bottom){_recordScreen.renderPlayOut()}else{_recordScreen.renderPlayRoll();return}break}}function buildBoard(){var a=_levelData["level"+_level];var b=a.colors;var c=a.size;var d=b.length/c;trace(d);_currentBoardSize=c*TILE_SIZE+TILE_SPACING*c;var e=_canvas.width/2-_currentBoardSize/2;var f=d<5?100:100-TILE_SIZE;var g;var h;var i=e;var j=f;for(h=0;h<b.length;h++){g=new Tile({x:i,y:j},b[h],h);i+=TILE_SIZE+TILE_SPACING;if((h+1)%c==0){i=e;j+=TILE_SIZE+TILE_SPACING}_tiles.push(g)}}function updateScore(){_stage.clearRect(0,_canvas.height-60,300,200);_stage.fillStyle="#000000";_stage.font="bold 15pt Helvetica";_stage.textBaseline="bottom";_stage.textAlign="left";_stage.fillText("LEVEL ",10,_canvas.height-55);_stage.fillText("BONUS ",10,_canvas.height-30);_stage.fillText("SCORE ",10,_canvas.height-5);_stage.fillStyle="#FFFFFF";_stage.fillText(_level,90,_canvas.height-55);_stage.fillText(_bonus,90,_canvas.height-30);_stage.fillText(_totalScore,90,_canvas.height-5);_stage.restore()}function buildUI(){_restartBtn={};_restartBtn.x=510;_restartBtn.y=415;_restartBtn.width=_restart.width;_restartBtn.height=_restart.height;_restartBtn.rect={top:_restartBtn.y+20,right:_restartBtn.x+_restartBtn.width,bottom:_restartBtn.y+_restartBtn.height+20,left:_restartBtn.x+10};_stage.drawImage(_restart,_restartBtn.x,_restartBtn.y,_restart.width,_restart.height);var a=_ssData.frames["optionsButton.png"].frame;_stage.drawImage(_assets,a.x,a.y,a.w,a.h,390,415,a.w,a.h);_menuBtn={};var b={};b.top=430;b.right=380+a.w;b.bottom=430+a.h;b.left=400;_menuBtn.rect=b;_stage.save();updateScore()}function gameStateLevelComplete(){_currentScreen="levelWin";_stage.globalAlpha=1;_levelWinScreen.update();_levelWinScreen.render()}function gameStateFadeLevel(){_stage.clearRect(0,0,_canvas.width,_canvas.height);if(_stage.globalAlpha>.1){_stage.globalAlpha-=.1;var a;var b;for(a=0;a<_tiles.length;a++){b=_tiles[a];b.render()}}else{_totalScore+=1e3*(_level-1);_levelWinScreen.setBonus(_bonus,_totalScore);_totalScore+=_bonus;_canvas.onmousemove=checkRollOvers;switchGameState(GameStates.GAME_STATE_LEVEL_COMPLETE)}}function gameStateFlipTiles(){updateScore();_stage.clearRect(0,0,_canvas.width,_canvas.height-100);var a;var b;for(a=0;a<_tiles.length;a++){b=_tiles[a];if(b.getIsFlipping()){b.update()}b.render()}_cnt++;if(_cnt>TIME_TO_FLIP){_cnt=0;checkGameWin()}}function gameStateWaitForFlip(){}function gameStateLevelIn(){_cnt++;if(_cnt<TIME_LEVEL_IN){_stage.clearRect(0,0,_canvas.width,_canvas.height-100);var a;var b;for(a=0;a<_tiles.length;a++){b=_tiles[a];b.updateIntro();b.render()}}else{_cnt=0;document.onclick=boardClicked;switchGameState(GameStates.GAME_STATE_WAIT_FOR_FLIP)}}function gameStateNewLevel(){_currentScreen="";_stage.clearRect(0,0,_canvas.width,_canvas.height);_tiles=[];_currentTile=null;buildUI();buildBoard();_bonus=500*_tiles.length;updateScore();switchGameState(GameStates.GAME_STATE_LEVEL_IN)}function gameStateNewGame(){_currentScreen="title";_canvas.onmousemove=null;document.onclick=null;_cnt=0;switchGameState(GameStates.GAME_STATE_NEW_LEVEL)}function gameStateWaitingForNewGame(){}function gameStateHelp(){_currentScreen="help";_helpScreenOn=true;_stage.clearRect(0,0,_canvas.width,_canvas.height);_helpScreen.render();document.onclick=checkHelpClicked;_canvas.onmousemove=checkRollOvers;switchGameState(GameStates.GAME_STATE_WAITING_FOR_NEW_GAME)}function gameStateLevelScreen(){_currentScreen="";_canvas.onmousemove=null;document.onclick=null;_levelScreen.init();_levelScreen.render();document.onclick=checkLevelClicked;switchGameState(GameStates.GAME_STATE_WAITING_FOR_NEW_GAME)}function gameStateTitle(){_stage.clearRect(0,0,_canvas.width,_canvas.height);_titleScreen.render();_currentScreen="title";document.onclick=checkPlayClicked;_canvas.onmousemove=checkRollOvers;switchGameState(GameStates.GAME_STATE_WAITING_FOR_NEW_GAME)}function gameStateSplash(){_splashScreen.update();_splashScreen.render();if(_splashScreen.getSplashComplete()){switchGameState(GameStates.GAME_STATE_TITLE)}}function gameStateInit(){_userCurrentLevel=window.localStorage.getItem("level")==null?1:window.localStorage.getItem("level");_titleScreen=new TitleScreen({x:0,y:0});_splashScreen=new SplashScreen({x:0,y:0});_levelScreen=new LevelScreen({x:0,y:0});_levelWinScreen=new LevelWinScreen({x:0,y:0});_helpScreen=new HelpScreen({x:0,y:0});_recordScreen=new RecordScreen({x:0,y:0});_stage.globalAlpha=1;_helpScreenOn=false;switchGameState(GameStates.GAME_STATE_SPLASH)}function gameStateAssetsLoading(){_angle+=4;if(_numAssets==_numLoaded){_stage.globalAlpha-=.11;if(_stage.globalAlpha<.1){switchGameState(GameStates.GAME_STATE_INIT)}}_stage.clearRect(0,0,_canvas.width,_canvas.height);_stage.save();_stage.translate(_canvas.width/2-_gear.width/2,150);_stage.translate(_gear.width/2,_gear.width/2);_stage.rotate(_angle*TO_RADIANS);_stage.drawImage(_gear,-_gear.width/2,-_gear.height/2);_stage.restore()}function switchGameState(a){_currentGameState=a;switch(_currentGameState){case GameStates.GAME_STATE_ASSETS_LOADING:_currentGameStateFunction=gameStateAssetsLoading;break;case GameStates.GAME_STATE_INIT:_currentGameStateFunction=gameStateInit;break;case GameStates.GAME_STATE_WAITING_FOR_NEW_GAME:_currentGameStateFunction=gameStateWaitingForNewGame;break;case GameStates.GAME_STATE_NEW_LEVEL:_currentGameStateFunction=gameStateNewLevel;break;case GameStates.GAME_STATE_LEVEL_IN:_currentGameStateFunction=gameStateLevelIn;break;case GameStates.GAME_STATE_HELP:_currentGameStateFunction=gameStateHelp;break;case GameStates.GAME_STATE_WAIT_FOR_LOAD:_currentGameStateFunction=gameStateWaitForLoad;break;case GameStates.GAME_STATE_SPLASH:_currentGameStateFunction=gameStateSplash;break;case GameStates.GAME_STATE_TITLE:_currentGameStateFunction=gameStateTitle;break;case GameStates.GAME_STATE_LEVEL_SCREEN:_currentGameStateFunction=gameStateLevelScreen;break;case GameStates.GAME_STATE_NEW_GAME:_currentGameStateFunction=gameStateNewGame;break;case GameStates.GAME_STATE_WAIT_FOR_FLIP:_currentGameStateFunction=gameStateWaitForFlip;break;case GameStates.GAME_STATE_FLIP_TILES:_currentGameStateFunction=gameStateFlipTiles;break;case GameStates.GAME_STATE_LEVEL_COMPLETE:_currentGameStateFunction=gameStateLevelComplete;break;case GameStates.GAME_STATE_FADE_LEVEL:_currentGameStateFunction=gameStateFadeLevel;break;case GameStates.GAME_STATE_PLAY_LEVEL:_currentGameStateFunction=gameStatePlayLevel;break;case GameStates.GAME_STATE_GAME_OVER:_currentGameStateFunction=gameStateGameOver;break;case GameStates.GAME_STATE_PAUSE:_currentGameStateFunction=gameStatePause;break;case GameStates.GAME_STATE_WAIT:_currentGameStateFunction=gameStateWait;break}}function runGame(){if(_currentGameStateFunction==undefined){return}_currentGameStateFunction()}function init(){_mouse={x:0,y:0};var a=1e3/30;var b=setInterval(runGame,a);switchGameState(GameStates.GAME_STATE_ASSETS_LOADING);loadImages()}function imageLoaded(){_numLoaded++}function loadImages(){_ss=new Image;_ss.addEventListener("load",imageLoaded,false);_ss.src="assets/flipTile.png";_restart=new Image;_restart.addEventListener("load",imageLoaded,false);_restart.src="assets/restart.png";_assets=new Image;_assets.addEventListener("load",imageLoaded,false);_assets.src="assets/assets.png";return;_flip=document.createElement("audio");document.body.appendChild(_flip);_flip.addEventListener("canplaythrough",imageLoaded,false);_flip.setAttribute("src","assets/flip.mp3");_bling=document.createElement("audio");document.body.appendChild(_bling);_bling.addEventListener("canplaythrough",imageLoaded,false);_bling.setAttribute("src","assets/bling.mp3")}function initLoader(){_angle=0;_canvas=document.getElementById("canvas");_stage=_canvas.getContext("2d");_gear=document.getElementById("gear");_bg=document.getElementById("bg");document.getElementById("canvasBG").getContext("2d").drawImage(_bg,0,0,_bg.width,_bg.height);init()}function gotData(a){_ssData=a;initLoader()}function getData(){$.getJSON("assets/data.json",gotData)}var _levelScreenData=[1,1,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];var _levelData={level1:{size:3,colors:["black","black","white","black","white","black","white","black","black"]},level2:{size:3,colors:["black","black","black","white","white","white","black","black","black"]},level3:{size:3,colors:["white","black","white","black","white","black","white","black","white"]},level4:{size:4,colors:["black","white","black","black","white","black","black","white","black","black","white","black"]},level5:{size:4,colors:["black","white","white","white","white","black","black","white","white","white","white","black"]},level6:{size:4,colors:["black","white","white","white","white","black","white","white","white","white","black","white","white","white","white","black"]},level7:{size:4,colors:["white","black","black","white","black","black","black","black","black","black","black","black","white","black","black","white"]},level8:{size:4,colors:["black","black","black","white","black","white","black","black","black","black","white","black","white","black","black","black"]},level9:{size:5,colors:["black","black","black","black","black","black","black","black","black","white","white","black","black","black","black","black","black","black","black","black"]},level10:{size:5,colors:["white","black","black","white","black","black","black","black","black","white","white","black","black","black","black","black","white","black","black","white"]},level11:{size:5,colors:["white","black","white","black","white","black","black","white","black","black","white","white","white","white","white","black","black","white","black","black","white","black","white","black","white"]},level12:{size:5,colors:["white","white","black","white","white","white","white","black","white","white","black","black","white","black","black","white","white","black","white","white","white","white","black","white","white"]},level13:{size:5,colors:["black","white","white","black","white","white","black","black","black","black","white","black","black","black","white","black","black","black","black","white","white","black","white","white","black"]},level14:{size:6,colors:["black","white","white","white","black","black","black","black","black","black","black","black","white","black","black","black","black","white","black","black","black","black","black","black","black","black","white","white","white","black"]},level15:{size:6,colors:["black","black","black","black","black","white","white","black","white","white","white","white","black","white","white","white","white","black","white","white","white","white","black","white","white","black","black","black","black","black"]},level16:{size:6,colors:["black","white","white","white","white","black","white","black","black","black","black","white","white","black","white","white","black","white","white","black","white","white","black","white","white","black","black","black","black","white","black","white","white","white","white","black"]},level17:{size:6,colors:["black","black","white","white","white","black","black","white","black","white","black","white","white","black","black","black","white","white","white","white","black","black","black","white","white","black","white","black","white","black","black","white","white","white","black","black"]},level18:{size:6,colors:["black","white","black","black","white","black","black","white","white","white","white","black","black","white","black","black","white","black","black","white","black","black","white","black","black","white","white","white","white","black","black","white","black","black","white","black"]},level19:{size:7,colors:["black","white","white","white","white","black","white","white","white","black","black","black","black","black","black","white","white","black","black","black","white","black","white","white","black","white","white","white"]},level20:{size:7,colors:["white","black","black","white","black","black","black","black","black","white","white","black","black","black","black","black","black","white","white","black","black","black","black","black","white","black","black","white"]}};var _numAssets=3;var _numLoaded=0;var _stage;var _canvas;var _bg;var _ss;var _restart;var _gear;var _assets;var _flip;var _bling;var _restartBtn;var _menuBtn;var _titleScreen;var _splashScreen;var _levelScreen;var _levelWinScreen;var _helpScreen;var _recordScreen;const TILE_SIZE=50;const TILE_SPACING=2;const TIME_TO_FLIP=8;const TIME_LEVEL_IN=15;const TO_RADIANS=Math.PI/180;const BONUS_INC=75;var _currentGameState;var _currentGameStateFunction;var _nextGameStateFunction;var _level;var _userCurrentLevel;var _mouse;var _tiles;var _currentTile;var _currentBoardSize;var _cnt;var _angle;var _helpScreenOn;var _menuFromGame=false;var _currentScreen="";var _bonus=4500;var _totalScore=0